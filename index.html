<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyPok√©dex</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%23e3350d%22/><path d=%22M5,50 A45,45 0 0,0 95,50 Z%22 fill=%22white%22/><rect x=%225%22 y=%2245%22 width=%2290%22 height=%2210%22 fill=%22%23222%22/><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22none%22 stroke=%22%23222%22 stroke-width=%225%22/><circle cx=%2250%22 cy=%2250%22 r=%2215%22 fill=%22white%22 stroke=%22%23222%22 stroke-width=%225%22/><circle cx=%2250%22 cy=%2250%22 r=%226%22 fill=%22white%22 stroke=%22%23ccc%22 stroke-width=%221%22/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #e3350d; --bg-dark: #121214; --bg-card: #202024;
            --text-main: #e1e1e6; --text-sec: #a8a8b3;
            --accent: #04d361; --info: #3b82f6; --danger: #ef4444; --teleport: #00bcd4; --tm-color: #f5a623; --edit: #f39c12;
            --border: rgba(255, 255, 255, 0.1);
        }
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-dark); margin: 0; padding: 0; color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        header { background-color: rgba(18, 18, 20, 0.95); padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); z-index: 100; }
        h1 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .logo-icon { color: var(--primary); font-size: 1.8rem; }
        .btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text-main); padding: 8px 16px; border-radius: 12px; cursor: pointer; transition: 0.2s; font-family: inherit; }
        .btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-1px); }

        .tabs { display: flex; background: var(--bg-dark); border-bottom: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 15px; background: transparent; border: none; color: var(--text-sec); cursor: pointer; font-weight: 600; font-size: 1rem; border-bottom: 3px solid transparent; transition: 0.3s; font-family: inherit; }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        .controls { background: var(--bg-card); padding: 15px 25px; display: flex; gap: 15px; align-items: center; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
        select, input[type="text"] { background: #121214; color: white; border: 1px solid var(--border); padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; outline: none; }
        select:focus, input:focus { border-color: var(--primary); }
        
        .map-adder { display: flex; gap: 8px; align-items: center; background: rgba(255,255,255,0.03); padding: 5px 10px; border-radius: 12px; border: 1px solid var(--border); }
        .map-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: none; cursor: pointer; transition: 0.2s; font-size: 1.1rem; }
        .btn-save { background: var(--accent); color: #000; }
        .btn-new { background: var(--info); color: white; }
        .btn-edit { background: var(--edit); color: white; }
        .btn-del { background: var(--danger); color: white; }
        .map-btn:hover { transform: scale(1.1); filter: brightness(1.1); }

        .stats { margin-left: auto; font-size: 0.9rem; font-weight: 600; color: var(--primary); background: rgba(227, 53, 13, 0.1); padding: 5px 12px; border-radius: 20px; }

        .view { display: none; flex-grow: 1; height: 100%; position: relative; overflow: hidden; }
        .view.active { display: flex; flex-direction: column; }

        #grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; padding: 25px; overflow-y: auto; }
        .card { background: var(--bg-card); border-radius: 20px; padding: 15px; text-align: center; border: 2px solid transparent; cursor: pointer; transition: 0.3s; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .card:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.1); }
        .card img { width: 100px; height: 100px; object-fit: contain; filter: grayscale(100%) opacity(0.5); transition: 0.4s; }
        .card.captured { background: linear-gradient(145deg, #1a2e1a, #132013); border-color: var(--accent); }
        .card.captured img { filter: grayscale(0%) opacity(1) drop-shadow(0 0 8px rgba(4, 211, 97, 0.4)); }
        .card.captured .card-name { color: var(--accent); }
        .card-num { font-size: 0.75rem; font-weight: 700; color: #555; position: absolute; top: 12px; left: 15px; }
        .card-name { font-size: 0.95rem; text-transform: capitalize; font-weight: 600; color: var(--text-sec); margin-top: 5px; }
        .info-btn { position: absolute; top: 10px; right: 10px; width: 26px; height: 26px; background: rgba(255,255,255,0.1); border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 14px; color: white; transition: 0.2s; }
        .info-btn:hover { background: var(--info); transform: scale(1.1); }
        .card:hover .info-btn { display: flex; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #18181b; width: 90%; max-width: 550px; border-radius: 24px; padding: 30px; color: white; box-shadow: 0 25px 50px rgba(0,0,0,0.5); max-height: 85vh; overflow-y: auto; position: relative; border: 1px solid var(--border); }
        .modal-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .modal-img { width: 100px; height: 100px; background: rgba(255,255,255,0.03); border-radius: 50%; padding: 10px; border: 1px solid var(--border); }
        
        /* CORRE√á√ÉO DOS TIPOS: GAP E WRAP */
        .modal-types { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .type-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

        /* CORRE√á√ÉO DOS STATUS */
        .stat-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85rem; }
        .stat-label { width: 90px; color: var(--text-sec); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; }
        .stat-val { width: 35px; text-align: right; font-weight: bold; margin-right: 10px; }
        .stat-bar-bg { flex-grow: 1; background: #333; height: 8px; border-radius: 10px; overflow: hidden; }
        .stat-bar-fill { height: 100%; border-radius: 10px; background: linear-gradient(90deg, var(--info), #60a5fa); }

        .specs-box { background: rgba(255,255,255,0.03); padding: 20px; border-radius: 16px; margin-top: 20px; border: 1px solid var(--border); }
        .specs-title { color: var(--info); font-weight: 700; margin-bottom: 12px; display: block; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        
        .build-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .build-slot { background: #202024; padding: 10px; border-radius: 12px; text-align: center; font-weight: 600; text-transform: capitalize; font-size: 0.9rem; border: 1px solid var(--border); }
        .build-slot.stab { border-color: var(--info); color: #93c5fd; }
        .build-slot.cover { border-color: var(--tm-color); color: #fde047; }

        .move-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .move-tag { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; text-transform: capitalize; display: flex; align-items: center; gap: 6px; }
        .move-tag.natural { background: rgba(4, 211, 97, 0.15); color: #86efac; border: 1px solid rgba(4, 211, 97, 0.3); }
        .move-tag.tm { background: rgba(245, 166, 35, 0.15); color: #fcd34d; border: 1px solid rgba(245, 166, 35, 0.3); }
        .level-info { font-size: 0.7rem; opacity: 0.8; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 10px; }

        .user-notes { width: 100%; height: 100px; background: #121214; border: 1px solid var(--border); color: #eee; margin-top: 10px; border-radius: 12px; padding: 15px; font-family: inherit; font-size: 0.9rem; outline: none; }
        .close-modal { position: absolute; top: 20px; right: 25px; cursor: pointer; font-size: 2rem; color: var(--text-sec); transition: 0.2s; line-height: 1; }
        .close-modal:hover { color: white; }

        /* MAPA */
        #map-container { flex-grow: 1; background: #0f0f10; position: relative; overflow: hidden; cursor: crosshair; background-image: radial-gradient(#222 1px, transparent 1px); background-size: 24px 24px; }
        .toolbar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(32, 32, 36, 0.9); padding: 10px 20px; border-radius: 50px; display: flex; gap: 15px; z-index: 10; box-shadow: 0 10px 30px rgba(0,0,0,0.5); backdrop-filter: blur(10px); border: 1px solid var(--border); }
        .tool { width: 45px; height: 45px; border: none; background: transparent; color: #bbb; border-radius: 50%; cursor: pointer; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .tool:hover { background: rgba(255,255,255,0.1); color: white; transform: translateY(-2px); }
        .tool.active { background: var(--primary); color: white; box-shadow: 0 0 20px rgba(227, 53, 13, 0.4); }
        
        #loading { position: absolute; top:50%; left:50%; transform:translate(-50%, -50%); background: rgba(0,0,0,0.9); color: white; padding: 25px 50px; border-radius: 16px; z-index: 200; font-weight: 600; border: 1px solid var(--border); }
    </style>
</head>
<body>

<header>
    <h1><span class="logo-icon">‚óì</span> MyPok√©dex</h1>
    <div style="display:flex; gap:10px;">
        <button class="btn" onclick="exportData()">üíæ Backup</button>
        <button class="btn" onclick="document.getElementById('file-in').click()">üìÇ Restaurar</button>
        <input type="file" id="file-in" style="display:none" onchange="importData(this)">
    </div>
</header>

<div class="tabs">
    <button class="tab-btn active" onclick="setTab('dex')">Pok√©dex</button>
    <button class="tab-btn" onclick="setTab('map')">Mapas</button>
</div>

<div class="controls">
    <div>
        <label style="display:block; margin-bottom:5px;">Regi√£o:</label>
        <select id="region-select" onchange="changeRegion()"></select>
    </div>
    
    <div id="map-controls" style="display:none; gap: 15px; align-items: flex-end;">
        <div style="height:40px; width:1px; background:var(--border);"></div>
        <div>
            <label style="display:block; margin-bottom:5px;">Localiza√ß√£o:</label>
            <select id="submap-select" onchange="changeSubMap()" style="min-width: 200px;"></select>
        </div>
        
        <div class="map-adder">
            <input type="text" id="custom-map-url" placeholder="URL da imagem..." style="width: 140px;">
            <button class="map-btn btn-save" onclick="addCustomMap()" title="Salvar/Sobrescrever">üíæ</button>
            <button class="map-btn btn-new" onclick="addNewMap()" title="Criar Novo">‚ûï</button>
            <button class="map-btn btn-edit" onclick="renameCurrentMap()" title="Renomear">‚úèÔ∏è</button>
            <button class="map-btn btn-del" onclick="deleteCurrentMap()" title="Excluir">üóëÔ∏è</button>
        </div>
    </div>

    <div class="stats" id="stats">0/0</div>
</div>

<div id="loading">Carregando dados...</div>

<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="closeModal()">√ó</span>
        <div id="modal-body">Carregando...</div>
    </div>
</div>

<section id="view-dex" class="view active"><div id="grid"></div></section>
<section id="view-map" class="view">
    <div class="toolbar">
        <button class="tool active" id="t-move" onclick="setTool('move')" title="Mover">‚úã</button>
        <button class="tool" id="t-draw" onclick="setTool('draw')" title="Desenhar">‚úèÔ∏è</button>
        <button class="tool" id="t-tele" onclick="setTool('tele')" title="Criar Teleporte" style="color:var(--teleport)">üåÄ</button>
        <input type="color" id="color" value="#ef4444" style="height:40px; border:none; padding:0; width:40px; cursor: pointer; border-radius:50%; overflow:hidden; background:none;">
        <button class="tool" onclick="undo()" title="Desfazer">‚Ü©Ô∏è</button>
        <button class="tool" onclick="clearMap()" title="Limpar Tudo">üóëÔ∏è</button>
    </div>
    <div id="map-container"><canvas id="canvas"></canvas></div>
</section>

<script>
    // ================= CONFIGURA√á√ÉO =================
    const regions = [
        { id: 'kanto_rb', name: 'Kanto (FR/LG)', api: 2, type: 'reg', versionGroup: 'firered-leafgreen' },
        { id: 'johto_gs', name: 'Johto (HG/SS)', api: 3, type: 'reg', versionGroup: 'heartgold-soulsilver' },
        { id: 'hoenn_rs', name: 'Hoenn (R/S/E)', api: 4, type: 'reg', versionGroup: 'emerald' },
        { id: 'sinnoh', name: 'Sinnoh (Platinum)', api: 6, type: 'reg', versionGroup: 'platinum' },
        { id: 'unova', name: 'Unova (B2/W2)', api: 9, type: 'reg', versionGroup: 'black-2-white-2' },
        { id: 'kalos', name: 'Kalos (X/Y)', api: 12, type: 'reg', versionGroup: 'x-y' },
        { id: 'alola', name: 'Alola (S/M)', api: 16, type: 'reg', versionGroup: 'sun-moon' },
        { id: 'galar', name: 'Galar (Sw/Sh)', api: 27, type: 'reg', versionGroup: 'sword-shield' },
        { id: 'paldea', name: 'Paldea (Sc/Vi)', api: 31, type: 'reg', versionGroup: 'scarlet-violet' },
        { id: 'nat_gen1', name: 'National Dex (Gen 1)', api: 1, type: 'nat', limit: 151, relatedReg: 'kanto_rb', versionGroup: 'firered-leafgreen' },
        { id: 'nat_gen2', name: 'National Dex (Gen 2)', api: 1, type: 'nat', limit: 251, relatedReg: 'johto_gs', versionGroup: 'heartgold-soulsilver' },
        { id: 'nat_gen3', name: 'National Dex (Gen 3)', api: 1, type: 'nat', limit: 386, relatedReg: 'hoenn_rs', versionGroup: 'emerald' },
        { id: 'nat_gen4', name: 'National Dex (Gen 4)', api: 1, type: 'nat', limit: 493, relatedReg: 'sinnoh', versionGroup: 'platinum' },
        { id: 'nat_gen5', name: 'National Dex (Gen 5)', api: 1, type: 'nat', limit: 649, relatedReg: 'unova', versionGroup: 'black-2-white-2' },
        { id: 'nat_gen9', name: 'National Dex (Full)', api: 1, type: 'nat', limit: 1025, relatedReg: 'paldea', versionGroup: 'scarlet-violet' }
    ];

    const BASE_URL = 'https://raw.githubusercontent.com/kelseyyoung/FRLGIronmonMap/main/public/images/maps/';
    const JOHTO_BASE = 'https://raw.githubusercontent.com/kelseyyoung/HGSSIronmonMap/main/public/images/maps/';
    const HOENN_BASE = 'https://raw.githubusercontent.com/kelseyyoung/EmeraldIronmonMap/main/public/images/maps/';

    // --- LISTA COMPLETA DE MAPAS RESTAURADA ---
    const defaultMaps = {
        'default': { 'Mapa Mundi': 'https://upload.wikimedia.org/wikipedia/commons/8/80/World_Map_%28Pok%C3%A9mon%29.png' },
        'kanto_rb': {
            '00. Mapa Geral': 'https://upload.wikimedia.org/wikipedia/commons/5/53/Kanto_place_names.png',
            'Pallet Town': BASE_URL + 'Pallet%20Town.png', 'Viridian City': BASE_URL + 'Viridian%20City.png', 'Pewter City': BASE_URL + 'Pewter%20City.png', 'Cerulean City': BASE_URL + 'Cerulean%20City.png', 'Vermilion City': BASE_URL + 'Vermilion%20City.png', 'Lavender Town': BASE_URL + 'Lavender%20Town.png', 'Celadon City': BASE_URL + 'Celadon%20City.png', 'Fuchsia City': BASE_URL + 'Fuchsia%20City.png', 'Saffron City': BASE_URL + 'Saffron%20City.png', 'Cinnabar Island': BASE_URL + 'Cinnabar%20Island.png',
            'Rota 1': BASE_URL + 'Route%201.png', 'Rota 2': BASE_URL + 'Route%202.png', 'Rota 3': BASE_URL + 'Route%203.png', 'Rota 4': BASE_URL + 'Route%204.png', 'Rota 5': BASE_URL + 'Route%205.png', 'Rota 6': BASE_URL + 'Route%206.png', 'Rota 7': BASE_URL + 'Route%207.png', 'Rota 8': BASE_URL + 'Route%208.png', 'Rota 9': BASE_URL + 'Route%209.png', 'Rota 10': BASE_URL + 'Route%2010.png', 'Rota 11': BASE_URL + 'Route%2011.png', 'Rota 12': BASE_URL + 'Route%2012.png', 'Rota 13': BASE_URL + 'Route%2013.png', 'Rota 14': BASE_URL + 'Route%2014.png', 'Rota 15': BASE_URL + 'Route%2015.png', 'Rota 16': BASE_URL + 'Route%2016.png', 'Rota 17': BASE_URL + 'Route%2017.png', 'Rota 18': BASE_URL + 'Route%2018.png', 'Rota 19': BASE_URL + 'Route%2019.png', 'Rota 20': BASE_URL + 'Route%2020.png', 'Rota 21': BASE_URL + 'Route%2021.png', 'Rota 22': BASE_URL + 'Route%2022.png', 'Rota 23': BASE_URL + 'Route%2023.png', 'Rota 24': BASE_URL + 'Route%2024.png', 'Rota 25': BASE_URL + 'Route%2025.png',
            'Viridian Forest': BASE_URL + 'Viridian%20Forest.png', 'Mt. Moon 1F': BASE_URL + 'Mt%20Moon%201F.png', 'Mt. Moon B1F': BASE_URL + 'Mt%20Moon%20B1F.png', 'Mt. Moon B2F': BASE_URL + 'Mt%20Moon%20B2F.png', 'Rock Tunnel 1F': BASE_URL + 'Rock%20Tunnel%201F.png', 'Rock Tunnel B1F': BASE_URL + 'Rock%20Tunnel%20B1F.png', 'Power Plant': BASE_URL + 'Power%20Plant.png', 'Pokemon Tower 3F': BASE_URL + 'Pokemon%20Tower%203F.png', 'Pokemon Tower 4F': BASE_URL + 'Pokemon%20Tower%204F.png', 'Pokemon Tower 5F': BASE_URL + 'Pokemon%20Tower%205F.png', 'Pokemon Tower 6F': BASE_URL + 'Pokemon%20Tower%206F.png', 'Pokemon Tower 7F': BASE_URL + 'Pokemon%20Tower%207F.png',
            'Safari Center': BASE_URL + 'Safari%20Zone%20Center.png', 'Safari East': BASE_URL + 'Safari%20Zone%20Area%201.png', 'Safari North': BASE_URL + 'Safari%20Zone%20Area%202.png', 'Safari West': BASE_URL + 'Safari%20Zone%20Area%203.png',
            'Seafoam B1F': BASE_URL + 'Seafoam%20Islands%20B1F.png', 'Seafoam B2F': BASE_URL + 'Seafoam%20Islands%20B2F.png', 'Seafoam B3F': BASE_URL + 'Seafoam%20Islands%20B3F.png', 'Seafoam B4F': BASE_URL + 'Seafoam%20Islands%20B4F.png',
            'Pokemon Mansion 1F': BASE_URL + 'Pokemon%20Mansion%201F.png', 'Pokemon Mansion 2F': BASE_URL + 'Pokemon%20Mansion%202F.png', 'Pokemon Mansion 3F': BASE_URL + 'Pokemon%20Mansion%203F.png', 'Pokemon Mansion B1F': BASE_URL + 'Pokemon%20Mansion%20B1F.png',
            'Victory Road 1F': BASE_URL + 'Victory%20Road%201F.png', 'Victory Road 2F': BASE_URL + 'Victory%20Road%202F.png', 'Victory Road 3F': BASE_URL + 'Victory%20Road%203F.png', 'Cerulean Cave 1F': BASE_URL + 'Cerulean%20Cave%201F.png', 'Cerulean Cave 2F': BASE_URL + 'Cerulean%20Cave%202F.png', 'Cerulean Cave B1F': BASE_URL + 'Cerulean%20Cave%20B1F.png',
            'Silph Co 1F': BASE_URL + 'Silph%20Co%201F.png', 'Silph Co 2F': BASE_URL + 'Silph%20Co%202F.png', 'Silph Co 3F': BASE_URL + 'Silph%20Co%203F.png', 'Silph Co 4F': BASE_URL + 'Silph%20Co%204F.png', 'Silph Co 5F': BASE_URL + 'Silph%20Co%205F.png', 'Silph Co 6F': BASE_URL + 'Silph%20Co%206F.png', 'Silph Co 7F': BASE_URL + 'Silph%20Co%207F.png', 'Silph Co 8F': BASE_URL + 'Silph%20Co%208F.png', 'Silph Co 9F': BASE_URL + 'Silph%20Co%209F.png', 'Silph Co 10F': BASE_URL + 'Silph%20Co%2010F.png', 'Silph Co 11F': BASE_URL + 'Silph%20Co%2011F.png',
            'Rocket Hideout B1F': BASE_URL + 'Rocket%20Hideout%20B1F.png', 'Rocket Hideout B2F': BASE_URL + 'Rocket%20Hideout%20B2F.png', 'Rocket Hideout B3F': BASE_URL + 'Rocket%20Hideout%20B3F.png', 'Rocket Hideout B4F': BASE_URL + 'Rocket%20Hideout%20B4F.png'
        },
        'johto_gs': {
            '00. Mapa Geral': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/64/JohtoMap.png/800px-JohtoMap.png',
            'New Bark Town': JOHTO_BASE + 'New%20Bark%20Town.png', 'Cherrygrove City': JOHTO_BASE + 'Cherrygrove%20City.png', 'Violet City': JOHTO_BASE + 'Violet%20City.png', 'Azalea Town': JOHTO_BASE + 'Azalea%20Town.png', 'Goldenrod City': JOHTO_BASE + 'Goldenrod%20City.png', 'Ecruteak City': JOHTO_BASE + 'Ecruteak%20City.png', 'Olivine City': JOHTO_BASE + 'Olivine%20City.png', 'Cianwood City': JOHTO_BASE + 'Cianwood%20City.png', 'Mahogany Town': JOHTO_BASE + 'Mahogany%20Town.png', 'Blackthorn City': JOHTO_BASE + 'Blackthorn%20City.png',
            'Rota 29': JOHTO_BASE + 'Route%2029.png', 'Rota 30': JOHTO_BASE + 'Route%2030.png', 'Rota 31': JOHTO_BASE + 'Route%2031.png', 'Rota 32': JOHTO_BASE + 'Route%2032.png', 'Rota 33': JOHTO_BASE + 'Route%2033.png', 'Rota 34': JOHTO_BASE + 'Route%2034.png', 'Rota 35': JOHTO_BASE + 'Route%2035.png', 'Rota 36': JOHTO_BASE + 'Route%2036.png',
            'Union Cave 1F': JOHTO_BASE + 'Union%20Cave%201F.png', 'Ruins of Alph': JOHTO_BASE + 'Ruins%20of%20Alph%20Interior.png', 'Slowpoke Well': JOHTO_BASE + 'Slowpoke%20Well%20B1F.png', 'Ilex Forest': JOHTO_BASE + 'Ilex%20Forest.png', 'Burned Tower 1F': JOHTO_BASE + 'Burned%20Tower%201F.png', 'Sprout Tower 1F': JOHTO_BASE + 'Sprout%20Tower%201F.png', 'Tin Tower 9F': JOHTO_BASE + 'Bell%20Tower%209F.png', 'Whirl Islands B2F': JOHTO_BASE + 'Whirl%20Islands%20B2F.png', 'Mt Mortar 1F': JOHTO_BASE + 'Mt%20Mortar%201F%20Entrance.png', 'Lake of Rage': JOHTO_BASE + 'Lake%20of%20Rage.png', 'Ice Path 1F': JOHTO_BASE + 'Ice%20Path%201F.png', 'Dragons Den': JOHTO_BASE + 'Dragons%20Den.png', 'Mt Silver': JOHTO_BASE + 'Mt%20Silver.png'
        },
        'hoenn_rs': { 
            '00. Mapa Geral': 'https://upload.wikimedia.org/wikipedia/commons/b/b9/Hoenn_place_names.png',
            'Littleroot Town': HOENN_BASE + 'Littleroot%20Town.png', 'Oldale Town': HOENN_BASE + 'Oldale%20Town.png', 'Petalburg City': HOENN_BASE + 'Petalburg%20City.png', 'Rustboro City': HOENN_BASE + 'Rustboro%20City.png', 'Dewford Town': HOENN_BASE + 'Dewford%20Town.png', 'Slateport City': HOENN_BASE + 'Slateport%20City.png', 'Mauville City': HOENN_BASE + 'Mauville%20City.png', 'Verdanturf Town': HOENN_BASE + 'Verdanturf%20Town.png', 'Fallarbor Town': HOENN_BASE + 'Fallarbor%20Town.png', 'Lavaridge Town': HOENN_BASE + 'Lavaridge%20Town.png',
            'Rota 101': HOENN_BASE + 'Route%20101.png', 'Rota 102': HOENN_BASE + 'Route%20102.png', 'Rota 103': HOENN_BASE + 'Route%20103.png', 'Rota 104': HOENN_BASE + 'Route%20104.png',
            'Petalburg Woods': HOENN_BASE + 'Petalburg%20Woods.png', 'Granite Cave 1F': HOENN_BASE + 'Granite%20Cave%201F.png', 'Meteor Falls': HOENN_BASE + 'Meteor%20Falls%201F%201R.png', 'Mt Chimney': HOENN_BASE + 'Mt%20Chimney.png', 'Jagged Pass': HOENN_BASE + 'Jagged%20Pass.png', 'Safari Zone South': HOENN_BASE + 'Safari%20Zone%20South.png', 'Mt Pyre 1F': HOENN_BASE + 'Mt%20Pyre%201F.png', 'Seafloor Cavern': HOENN_BASE + 'Seafloor%20Cavern%20Room%201.png', 'Cave of Origin': HOENN_BASE + 'Cave%20of%20Origin%201F.png', 'Sky Pillar 5F': HOENN_BASE + 'Sky%20Pillar%205F.png', 'Victory Road 1F': HOENN_BASE + 'Victory%20Road%201F.png'
        },
        'sinnoh': { 'Mapa Geral': 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/74/Sinnoh_place_names.png/800px-Sinnoh_place_names.png' },
        'unova': { 'Mapa Geral': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/64/Unova_place_names.png/800px-Unova_place_names.png' },
        'kalos': { 'Mapa Geral': 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/52/Kalos_place_names.png/800px-Kalos_place_names.png' },
        'alola': { 'Mapa Geral': 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0b/Alola_USUM_Map.png/800px-Alola_USUM_Map.png' },
        'galar': { 'Mapa Geral': 'https://upload.wikimedia.org/wikipedia/commons/c/ce/Galar_Map.png' },
        'paldea': { 'Mapa Geral': 'https://upload.wikimedia.org/wikipedia/commons/9/9e/Paldea_Map.png' }
    };

    const strongMoves = { fire: ['flamethrower', 'fire-blast', 'heat-wave', 'flare-blitz'], water: ['surf', 'hydro-pump', 'scald', 'waterfall'], grass: ['energy-ball', 'giga-drain', 'solar-beam'], electric: ['thunderbolt', 'thunder', 'volt-switch'], ice: ['ice-beam', 'blizzard'], fighting: ['close-combat', 'brick-break'], poison: ['sludge-bomb', 'toxic'], ground: ['earthquake', 'earth-power'], flying: ['fly', 'brave-bird'], psychic: ['psychic', 'shadow-ball'], bug: ['x-scissor', 'u-turn'], rock: ['rock-slide', 'stone-edge'], ghost: ['shadow-ball', 'hex'], dragon: ['dragon-claw', 'outrage'], dark: ['crunch', 'dark-pulse'], steel: ['flash-cannon', 'iron-head'], fairy: ['moonblast', 'play-rough'], normal: ['return', 'hyper-beam'] };

    let db = JSON.parse(localStorage.getItem('poke_db_ultimate')) || { captured: {}, customMaps: {}, drawings: {}, notes: {}, teleports: {} };
    if(!db.teleports) db.teleports = {};

    let currentRegId = 'kanto_rb';
    let currentSubMapName = '00. Mapa Geral';
    let currentPokeList = [];
    
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let mapImg = new Image();
    let view = { x: 0, y: 0, scale: 1 };
    let isDrag = false, isDraw = false;
    let tool = 'move';
    let lastPos = { x:0, y:0 };
    let currentPath = [];

    window.onload = () => {
        updateRegionSelect('dex');
        const lastReg = localStorage.getItem('last_reg');
        if(lastReg && document.getElementById('region-select').querySelector(`option[value="${lastReg}"]`)) {
            document.getElementById('region-select').value = lastReg;
        }
        initCanvas();
        changeRegion();
    };

    function setTab(mode) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`view-${mode}`).classList.add('active');
        event.target.classList.add('active');
        document.getElementById('map-controls').style.display = (mode === 'map') ? 'flex' : 'none';
        updateRegionSelect(mode);
        if(mode === 'map') { resizeCanvas(); updateSubMapSelect(); changeSubMap(); }
    }

    function updateRegionSelect(mode) {
        const sel = document.getElementById('region-select');
        const currentVal = sel.value || 'kanto_rb';
        sel.innerHTML = '';
        let validSelection = false;
        let fallback = null;
        regions.forEach(r => {
            if(mode === 'map' && r.type === 'nat') return;
            let opt = document.createElement('option');
            opt.value = r.id; opt.innerText = r.name;
            sel.appendChild(opt);
            if(r.id === currentVal) validSelection = true;
            if(!fallback) fallback = r.id; 
        });
        if(validSelection) sel.value = currentVal;
        else {
            const currentConfig = regions.find(r => r.id === currentVal);
            sel.value = (currentConfig && currentConfig.relatedReg) ? currentConfig.relatedReg : fallback;
            changeRegion(); 
        }
    }

    async function changeRegion() {
        const sel = document.getElementById('region-select');
        currentRegId = sel.value;
        localStorage.setItem('last_reg', currentRegId); 
        const loading = document.getElementById('loading');
        loading.style.display = 'block';
        const config = regions.find(r => r.id === currentRegId);
        if(!config) { loading.style.display = 'none'; return; }

        try {
            const res = await fetch(`https://pokeapi.co/api/v2/pokedex/${config.api}`);
            const data = await res.json();
            currentPokeList = data.pokemon_entries.map(e => ({
                id: parseInt(e.pokemon_species.url.split('/').slice(-2, -1)[0]),
                name: e.pokemon_species.name,
                num: e.entry_number
            }));
            if (config.type === 'nat') {
                currentPokeList = currentPokeList.filter(p => p.id <= config.limit);
                currentPokeList.sort((a,b) => a.id - b.id);
            } else {
                currentPokeList.sort((a,b) => a.num - b.num);
            }
            renderDex();
        } catch(e) { console.error(e); }
        finally { loading.style.display = 'none'; }
        updateSubMapSelect();
        if(document.getElementById('view-map').classList.contains('active')) changeSubMap();
    }

    function renderDex() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        const captured = db.captured[currentRegId] || [];
        const fragment = document.createDocumentFragment();
        currentPokeList.forEach(pk => {
            const d = document.createElement('div');
            d.className = 'card ' + (captured.includes(pk.id) ? 'captured' : '');
            const imgUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${pk.id}.png`;
            d.innerHTML = `<div class="info-btn" title="Info">i</div><img src="${imgUrl}" loading="lazy"><div class="card-num">#${pk.id}</div><div class="card-name">${pk.name.replace(/-/g, ' ')}</div>`;
            d.onclick = () => toggle(pk.id, d);
            d.querySelector('.info-btn').onclick = (e) => { e.stopPropagation(); openPokemonDetails(pk.id); };
            fragment.appendChild(d);
        });
        grid.appendChild(fragment);
        updateStats();
    }

    function toggle(id, el) {
        if(!db.captured[currentRegId]) db.captured[currentRegId] = [];
        const idx = db.captured[currentRegId].indexOf(id);
        if(idx > -1) { db.captured[currentRegId].splice(idx, 1); el.classList.remove('captured'); } 
        else { db.captured[currentRegId].push(id); el.classList.add('captured'); }
        save(); updateStats();
    }

    function updateStats() {
        const c = (db.captured[currentRegId] || []).length;
        const t = currentPokeList.length;
        const p = t > 0 ? Math.floor((c/t)*100) : 0;
        document.getElementById('stats').innerText = `${c} / ${t} (${p}%)`;
    }

    // ================= DETALHES COMPLETOS (CORRIGIDO) =================
    const typeColors = { normal:'#A8A77A', fire:'#EE8130', water:'#6390F0', electric:'#F7D02C', grass:'#7AC74C', ice:'#96D9D6', fighting:'#C22E28', poison:'#A33EA1', ground:'#E2BF65', flying:'#A98FF3', psychic:'#F95587', bug:'#A6B91A', rock:'#B6A136', ghost:'#735797', dragon:'#6F35FC', dark:'#705746', steel:'#B7B7CE', fairy:'#D685AD' };

    async function openPokemonDetails(id) {
        const modal = document.getElementById('modal-overlay');
        const body = document.getElementById('modal-body');
        modal.style.display = 'flex';
        body.innerHTML = '<p style="text-align:center;">Consultando dados...</p>';

        try {
            const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
            const data = await res.json();
            const speciesRes = await fetch(data.species.url);
            const speciesData = await speciesRes.json();
            const evoRes = await fetch(speciesData.evolution_chain.url);
            const evoData = await evoRes.json();

            // Configura√ß√£o da Regi√£o
            const currentConfig = regions.find(r => r.id === currentRegId);
            const targetVersion = currentConfig ? currentConfig.versionGroup : null;

            // Evolu√ß√£o
            const evoCap = getEvolutionLevel(evoData.chain, data.name) || 100;
            const evoText = evoCap === 100 ? "Forma Final" : `Evolui no lvl ${evoCap}`;

            // UNIFICAR RENDERIZA√á√ÉO
            const processed = {
                id: data.id,
                name: data.name,
                img: data.sprites.other['official-artwork'].front_default,
                types: data.types.map(t => t.type.name),
                // Converte stats array para objeto para facilitar
                stats: data.stats.reduce((acc, s) => ({ ...acc, [s.stat.name]: s.base_stat }), {}),
                evoText: evoText
            };

            // HTML GEN: Tipos
            let typesHtml = processed.types.map(t => `<span class="type-badge" style="background:${typeColors[t] || '#777'}">${t}</span>`).join('');

            // HTML GEN: Stats (Ordem Fixa)
            const statOrder = ['hp', 'attack', 'defense', 'special-attack', 'special-defense', 'speed'];
            let statsHtml = statOrder.map(key => {
                const val = processed.stats[key] || 0;
                const width = Math.min(100, (val / 255) * 100);
                return `<div class="stat-row"><span class="stat-label">${key.replace('special-', 'sp.')}</span><span class="stat-val">${val}</span><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${width}%"></div></div></div>`;
            }).join('');

            // --- MOVES LOGIC (CRASH FIX: "reading '4'") ---
            const versionMoves = data.moves.filter(m => targetVersion ? m.version_group_details.some(v => v.version_group.name === targetVersion) : true);
            const movesSource = versionMoves.length > 0 ? versionMoves : data.moves;
            const versionToUse = versionMoves.length > 0 ? targetVersion : null;

            let naturalMoves = movesSource.map(m => {
                let detail = null;
                if (versionToUse) detail = m.version_group_details.find(v => v.version_group.name === versionToUse);
                else detail = m.version_group_details[m.version_group_details.length-1];

                if (!detail) return null;
                return { name: m.move.name, method: detail.move_learn_method.name, lvl: detail.level_learned_at };
            })
            .filter(m => m && m.method === 'level-up' && m.lvl <= evoCap && m.lvl > 1)
            .sort((a,b) => a.lvl - b.lvl)
            .slice(-6);

            let machineMoves = movesSource.map(m => {
                 let detail = null;
                if (versionToUse) detail = m.version_group_details.find(v => v.version_group.name === versionToUse);
                else detail = m.version_group_details[m.version_group_details.length-1];
                if (!detail) return null;
                return { name: m.move.name, method: detail.move_learn_method.name };
            }).filter(m => m && m.method === 'machine');

            // BUILD SUGGESTION
            let finalBuild = [];
            processed.types.forEach(t => {
                const best = strongMoves[t] || [];
                finalBuild.push(...naturalMoves.filter(m => best.includes(m.name)).map(m => ({name: m.name, type: 'stab'})));
                finalBuild.push(...machineMoves.filter(m => best.includes(m.name)).map(m => ({name: m.name, type: 'stab'})));
            });

            // Cobertura
             ['normal', 'ground', 'rock', 'flying', 'fighting', 'ice', 'electric'].forEach(ct => {
                if(!processed.types.includes(ct)) {
                    const covers = strongMoves[ct] || [];
                    finalBuild.push(...machineMoves.filter(m => covers.includes(m.name)).map(m => ({name: m.name, type: 'cover'})));
                }
            });

            // Unique and Slice Safe
            finalBuild = finalBuild.filter((v,i,a)=>a.findIndex(x=>(x.name === v.name))===i).slice(0, 4);
            
            // Fill holes
            if(finalBuild.length < 4) {
                const fillers = naturalMoves.sort((a,b) => b.lvl - a.lvl).slice(0, 4); // Take top 4 naturals
                fillers.forEach(f => {
                    if(finalBuild.length < 4 && !finalBuild.some(fb => fb.name === f.name)) {
                         finalBuild.push({name: f.name, type: 'stab'});
                    }
                });
            }

            let movesetHtml = finalBuild.map(m => `<div class="build-slot ${m.type}">${m.name.replace(/-/g, ' ')}</div>`).join('');
            let naturalHtml = naturalMoves.map(m => `<span class="move-tag natural">${m.name.replace(/-/g, ' ')} <span class="level-info">Lv.${m.lvl}</span></span>`).join('');
            let displayTms = machineMoves.slice(0, 8).map(m => `<span class="move-tag tm">${m.name.replace(/-/g, ' ')} <span class="level-info">TM</span></span>`).join('');

            // Natureza
            let isPhysical = processed.stats.attack >= processed.stats['special-attack'];
            let natureText = processed.stats.speed >= 100 ? (isPhysical ? "Jolly" : "Timid") : (isPhysical ? "Adamant" : "Modest");

            const notes = db.notes[id] || "";

            body.innerHTML = `
                <div class="modal-header">
                    <img src="${processed.img}" class="modal-img">
                    <div class="modal-title">
                        <h2>${processed.name}</h2>
                        <div class="modal-types">${typesHtml} <span style="font-size:0.8rem; color:#aaa; margin-left:10px;">(${evoText})</span></div>
                    </div>
                </div>
                <div style="margin-bottom:15px;">${statsHtml}</div>
                <div class="specs-box" style="margin-top:0;">
                    <span class="specs-title">üèÜ Build Recomendada</span>
                    <div class="build-grid">${movesetHtml || '<span style="color:#777; font-size:0.8rem;">Sem dados.</span>'}</div>
                </div>
                <div class="specs-box">
                    <span class="specs-title" style="color:#4caf50;">üçÉ Naturais (At√© lvl ${evoCap})</span>
                    <div class="move-grid">${naturalHtml || '<span style="color:#777; font-size:0.8rem;">Iniciais.</span>'}</div>
                    <div style="height:5px;"></div>
                    <span class="specs-title" style="color:var(--tm-color);">üíø TMs Dispon√≠veis</span>
                    <div class="move-grid">${displayTms || '<span style="color:#777; font-size:0.8rem;">Nenhum relevante.</span>'}</div>
                </div>
                <div class="specs-box">
                    <span class="specs-title">‚ö° Sugest√£o de Treino</span>
                    <p style="margin:5px 0; font-size:0.9rem;"><strong>Natureza:</strong> ${natureText}</p>
                    <p style="margin:5px 0; font-size:0.9rem;"><strong>Foco:</strong> ${processed.stats.speed >= 80 ? 'Speed' : 'HP'} + ${isPhysical ? 'Atk' : 'Sp.Atk'}</p>
                </div>
                <div class="specs-box">
                    <span class="specs-title">üìù Anota√ß√µes</span>
                    <textarea class="user-notes" id="notes-${id}" placeholder="Escreva sua build...">${notes}</textarea>
                    <button class="btn" style="width:100%; margin-top:5px; background:var(--accent);" onclick="saveNote(${id})">Salvar</button>
                </div>
            `;
        } catch (err) { console.error(err); body.innerHTML = `<p style="color:#ef4444; font-weight:bold;">Erro.</p><p style="font-size:0.8rem;">${err.message}</p>`; }
    }

    function getEvolutionLevel(chain, currentName) {
        if (chain.species.name === currentName) {
            if (chain.evolves_to.length > 0) return chain.evolves_to[0].evolution_details[0]?.min_level || 100; 
            return 100;
        }
        for (let i = 0; i < chain.evolves_to.length; i++) {
            const level = getEvolutionLevel(chain.evolves_to[i], currentName);
            if (level) return level;
        }
        return null;
    }

    function closeModal(e) {
        if(!e || e.target.id === 'modal-overlay' || e.target.classList.contains('close-modal')) {
            document.getElementById('modal-overlay').style.display = 'none';
        }
    }

    window.saveNote = function(id) {
        const val = document.getElementById(`notes-${id}`).value;
        if(!db.notes) db.notes = {};
        db.notes[id] = val;
        save(); alert("Salvo!");
    };

    // ================= MAPAS & CANVAS =================
    function updateSubMapSelect() {
        const sel = document.getElementById('submap-select');
        sel.innerHTML = '';
        const defaults = defaultMaps[currentRegId] || defaultMaps['default'];
        const customs = db.customMaps[currentRegId] || {};
        const allMaps = { ...defaults, ...customs };
        const sortedKeys = Object.keys(allMaps).sort((a,b) => {
            if(a.includes('Mapa Geral')) return -1;
            if(b.includes('Mapa Geral')) return 1;
            return a.localeCompare(b, undefined, {numeric: true});
        });

        sortedKeys.forEach(name => {
            let opt = document.createElement('option');
            opt.value = allMaps[name]; opt.innerText = name;
            sel.appendChild(opt);
        });
    }

    function changeSubMap() {
        const sel = document.getElementById('submap-select');
        if(!sel.value) return; 
        currentSubMapName = sel.options[sel.selectedIndex].text;
        const customUrl = db.customMaps[currentRegId]?.[currentSubMapName];
        document.getElementById('custom-map-url').value = customUrl || "";
        mapImg = new Image();
        mapImg.crossOrigin = "Anonymous"; 
        mapImg.onerror = () => { draw(); };
        mapImg.src = sel.value;
        mapImg.onload = () => {
            view = { x: (canvas.width - mapImg.width)/2, y: (canvas.height - mapImg.height)/2, scale: 0.8 };
            if(mapImg.width > 2000) view.scale = 0.4;
            if(mapImg.width < 500) view.scale = 1.5;
            draw();
        };
    }

    function addCustomMap() {
        const url = document.getElementById('custom-map-url').value;
        if(!url) return;
        let name = currentSubMapName;
        const isDefault = Object.values(defaultMaps).some(reg => Object.values(reg).includes(url)) || defaultMaps[currentRegId]?.[name];
        if(isDefault) {
             const newName = prompt(`Nome do mapa personalizado:`, name + " Custom");
             if(!newName) return;
             name = newName;
        }
        if(!db.customMaps[currentRegId]) db.customMaps[currentRegId] = {};
        db.customMaps[currentRegId][name] = url;
        save(); alert(`Mapa salvo!`); updateSubMapSelect();
        const sel = document.getElementById('submap-select');
        for(let i=0; i<sel.options.length; i++) { if(sel.options[i].text === name) sel.selectedIndex = i; }
        changeSubMap();
    }
    
    function addNewMap() {
        const url = document.getElementById('custom-map-url').value;
        const name = prompt("Nome do Novo Mapa:");
        if(name && url) {
            if(!db.customMaps[currentRegId]) db.customMaps[currentRegId] = {};
            db.customMaps[currentRegId][name] = url;
            save(); updateSubMapSelect();
            const sel = document.getElementById('submap-select');
            for(let i=0; i<sel.options.length; i++) { if(sel.options[i].text === name) sel.selectedIndex = i; }
            changeSubMap();
        }
    }
    
    function renameCurrentMap() {
        const oldName = currentSubMapName;
        const newName = prompt("Novo nome:", oldName);
        if(!newName || newName === oldName) return;
        const url = db.customMaps[currentRegId]?.[oldName] || defaultMaps[currentRegId]?.[oldName];
        if(!db.customMaps[currentRegId]) db.customMaps[currentRegId] = {};
        db.customMaps[currentRegId][newName] = url;
        if(db.customMaps[currentRegId][oldName]) delete db.customMaps[currentRegId][oldName];
        save(); updateSubMapSelect();
        const sel = document.getElementById('submap-select');
        for(let i=0; i<sel.options.length; i++) { if(sel.options[i].text === newName) sel.selectedIndex = i; }
        changeSubMap();
    }

    function deleteCurrentMap() {
        const name = currentSubMapName;
        if (db.customMaps[currentRegId] && db.customMaps[currentRegId][name]) {
            if(confirm(`Excluir personaliza√ß√£o de "${name}"?`)) {
                delete db.customMaps[currentRegId][name];
                save(); alert("Exclu√≠do!"); updateSubMapSelect(); changeSubMap();
            }
        } else {
            alert("N√£o √© poss√≠vel excluir mapas originais.");
        }
    }

    function initCanvas() {
        window.addEventListener('resize', resizeCanvas);
        canvas.addEventListener('mousedown', startInteract);
        canvas.addEventListener('mousemove', moveInteract);
        canvas.addEventListener('mouseup', endInteract);
        canvas.addEventListener('wheel', (e) => { e.preventDefault(); const zoom = e.deltaY > 0 ? 0.9 : 1.1; view.scale *= zoom; draw(); });
    }

    function resizeCanvas() {
        const container = document.getElementById('map-container');
        if(container) { canvas.width = container.clientWidth; canvas.height = container.clientHeight; draw(); }
    }

    function getMapKey() { return `${currentRegId}_${currentSubMapName}`; }

    function draw() {
        ctx.fillStyle = '#111'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.save(); ctx.translate(view.x, view.y); ctx.scale(view.scale, view.scale);
        if(mapImg.complete && mapImg.naturalWidth > 0) ctx.drawImage(mapImg, 0, 0);
        else { ctx.fillStyle = "#333"; ctx.fillRect(0, 0, 500, 150); ctx.fillStyle = "white"; ctx.font = "20px Arial"; ctx.fillText("Imagem n√£o carregada.", 20, 50); }
        const key = getMapKey(); const paths = db.drawings[key] || []; const teleports = db.teleports[key] || [];
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        paths.forEach(p => {
            ctx.beginPath(); ctx.strokeStyle = p.color; ctx.lineWidth = p.width / view.scale;
            if(p.points.length > 0) { ctx.moveTo(p.points[0].x, p.points[0].y); for(let i=1; i<p.points.length; i++) ctx.lineTo(p.points[i].x, p.points[i].y); }
            ctx.stroke();
        });
        if(currentPath.length > 0) {
            ctx.beginPath(); ctx.strokeStyle = document.getElementById('color').value; ctx.lineWidth = 5 / view.scale;
            ctx.moveTo(currentPath[0].x, currentPath[0].y); for(let i=1; i<currentPath.length; i++) ctx.lineTo(currentPath[i].x, currentPath[i].y);
            ctx.stroke();
        }
        teleports.forEach(t => {
            ctx.beginPath(); ctx.arc(t.x, t.y, 10 / view.scale, 0, 2 * Math.PI); ctx.fillStyle = 'rgba(0, 188, 212, 0.8)'; ctx.fill(); ctx.lineWidth = 2 / view.scale; ctx.strokeStyle = 'white'; ctx.stroke();
            ctx.fillStyle = 'white'; ctx.font = `${12/view.scale}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('üåÄ', t.x, t.y);
        });
        ctx.restore();
    }

    function startInteract(e) {
        if(tool === 'tele') {
            const mx = (e.offsetX - view.x) / view.scale; const my = (e.offsetY - view.y) / view.scale;
            const maps = { ...defaultMaps[currentRegId], ...db.customMaps[currentRegId] };
            const options = Object.keys(maps);
            let dest = prompt("Digite o NOME do mapa de destino:\n\n" + options.slice(0,10).join("\n") + "\n...");
            if(dest && options.includes(dest)) {
                const key = getMapKey(); if(!db.teleports[key]) db.teleports[key] = [];
                db.teleports[key].push({ x: mx, y: my, target: dest }); save(); draw();
            } else if (dest) { alert("Mapa n√£o encontrado."); }
            return;
        }
        if(tool === 'move') {
            const mx = (e.offsetX - view.x) / view.scale; const my = (e.offsetY - view.y) / view.scale;
            const key = getMapKey(); const teleports = db.teleports[key] || [];
            for(let t of teleports) {
                const dist = Math.sqrt(Math.pow(mx - t.x, 2) + Math.pow(my - t.y, 2));
                if(dist < 15 / view.scale) {
                    const sel = document.getElementById('submap-select');
                    for(let i=0; i<sel.options.length; i++) { if(sel.options[i].text === t.target) { sel.selectedIndex = i; changeSubMap(); return; } }
                }
            }
        }
        isDrag = (tool === 'move'); isDraw = (tool === 'draw'); lastPos = { x: e.offsetX, y: e.offsetY }; 
        if(isDraw) { const mx = (e.offsetX - view.x) / view.scale; const my = (e.offsetY - view.y) / view.scale; currentPath = [{x: mx, y: my}]; }
    }

    function moveInteract(e) { 
        if(isDrag) { view.x += e.offsetX - lastPos.x; view.y += e.offsetY - lastPos.y; lastPos = { x: e.offsetX, y: e.offsetY }; draw(); } 
        if(isDraw) { const mx = (e.offsetX - view.x) / view.scale; const my = (e.offsetY - view.y) / view.scale; currentPath.push({x: mx, y: my}); draw(); } 
    }

    function endInteract() { 
        isDrag = false; 
        if(isDraw) { isDraw = false; if(currentPath.length > 1) { const key = getMapKey(); if(!db.drawings[key]) db.drawings[key] = []; db.drawings[key].push({ color: document.getElementById('color').value, width: 5, points: currentPath }); save(); } currentPath = []; draw(); } 
    }

    function setTool(t) { 
        tool = t; document.querySelectorAll('.tool').forEach(b => b.classList.remove('active')); document.getElementById('t-' + t).classList.add('active');
        document.getElementById('map-container').style.cursor = t === 'move' ? 'grab' : (t === 'tele' ? 'context-menu' : 'crosshair');
    }

    function undo() { const key = getMapKey(); if(db.drawings[key] && db.drawings[key].length > 0) { db.drawings[key].pop(); save(); draw(); } }
    function clearMap() { if(confirm("Limpar desenhos e teleportes?")) { db.drawings[getMapKey()] = []; db.teleports[getMapKey()] = []; save(); draw(); } }

    function save() { localStorage.setItem('poke_db_ultimate', JSON.stringify(db)); }
    function exportData() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); a.download = "poketracker_ultimate_backup.json"; a.click(); }
    function importData(inp) { const file = inp.files[0]; if(!file) return; const r = new FileReader(); r.onload = e => { if(confirm("Sobrescrever?")) { try { db = JSON.parse(e.target.result); if(!db.teleports) db.teleports = {}; save(); location.reload(); } catch(err) { alert("Inv√°lido!"); } } }; r.readAsText(file); }
</script>
</body>
</html>
